{% extends 'base.html' %}
{% load static %}
{% block title %}Horarios del Médico{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'css/ver_agenda.css' %}">
<style>
    .main-container {
        display: flex;
        gap: 20px;
    }
    .calendar-container {
        flex: 2;
    }
    .list-container {
        flex: 1;
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 8px;
        background: #f9f9f9;
        max-height: 400px; /* Tamaño específico */
        overflow-y: auto; /* Scrollbar */
    }
    .list-container h3 {
        text-align: center;
        margin-bottom: 10px;
    }
    .horario-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }
    .horario-item:last-child {
        border-bottom: none;
    }
    .horario-item button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }
    .horario-item button:hover {
        background-color: #0056b3;
    }
    /* Botones de navegación alineados */
    .fc-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .fc-toolbar-title {
        font-size: 1.5rem;
        font-weight: bold;
    }
    /* Resaltar días con horarios */
    .fc-highlight-day {
        background-color: #d4edda !important;
        color: #155724;
        font-weight: bold;
    }
    /* Días sin horarios */
    .fc-disabled-day {
        background-color: #e9ecef !important;
        pointer-events: none;
        cursor: default;
    }
</style>
{% endblock %}

{% block content %}
<div class="formulario">
    <h1>Horarios del Médico: {{ medico.rut.nombre }}</h1>
    <p><strong>Especialidad:</strong> {{ medico.especialidad }}</p>

    <div class="main-container">
        <div class="calendar-container">
            <div id="calendar"></div>
        </div>
        <div class="list-container">
            <h3>Horarios Disponibles</h3>
            <div id="horarios-list">
                <p>Seleccione un día en el calendario para ver los horarios disponibles.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/es.global.min.js"></script>

<script>
    const horarios = [
        {% for fecha, horarios in horarios_por_fecha.items %}
            {% for horario in horarios %}
                {
                    title: "{{ horario.sala.nombre }}",
                    start: "{{ horario.fechainicio|date:'Y-m-d H:i' }}",
                    extendedProps: {
                        fecha: "{{ horario.fechainicio|date:'Y-m-d' }}",
                        hora: "{{ horario.fechainicio|date:'H:i' }}",
                        sala: "{{ horario.sala.nombre }}",
                        direccion: "{{ horario.sala.direccion }}"
                    }
                },
            {% endfor %}
        {% endfor %}
    ];

    const fechasConHorarios = [...new Set(horarios.map(h => h.extendedProps.fecha))]; // Días únicos con horarios

    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const horariosListEl = document.getElementById('horarios-list');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'es',
            initialView: 'dayGridWeek',
            headerToolbar: {
                left: 'prev,next',
                center: 'title',
                right: ''
            },
            events: horarios,
            selectable: true,
            dayCellDidMount: function (info) {
                // Verificar si el día tiene horarios
                if (fechasConHorarios.includes(info.date.toISOString().split('T')[0])) {
                    info.el.classList.add('fc-highlight-day'); // Añadir clase de resaltado
                }
            },
            dateClick: function (info) {
                if (!fechasConHorarios.includes(info.dateStr)) return;

                const horariosFiltrados = horarios.filter(h => h.extendedProps.fecha === info.dateStr);
                horariosListEl.innerHTML = horariosFiltrados.length > 0
                    ? horariosFiltrados.map(horario => `
                        <div class="horario-item">
                            <div>
                                <strong>${horario.extendedProps.hora}</strong><br>
                                ${horario.extendedProps.sala}<br>
                                ${horario.extendedProps.direccion}
                            </div>
                            <button type="button" data-hora="${horario.extendedProps.hora}">Agendar</button>
                        </div>
                    `).join('')
                    : `<p>No hay horarios disponibles para el día seleccionado.</p>`;
            },
            eventContent: function () {
                return null;
            }
        });

        calendar.render();
    });
</script>

<style>
    .fc-disabled-day {
        background-color: #e9ecef !important;
        pointer-events: none;
        cursor: default;
    }
    .fc-highlight-day {
        background-color: #d4edda !important; /* Color de resaltado */
        border: 1px solid #28a745; /* Borde para mayor visibilidad */
    }
</style>
{% endblock %}


